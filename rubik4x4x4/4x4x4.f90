MODULE RUBIK4

   INTEGER(4),PARAMETER :: N=100000
   INTEGER(4) :: LIST(1:93,1:N),SUBLIST(1:93,1:N),NEWLIST(1:93,1:N)
   INTEGER(4) :: NEWIDENTITY(1:N),SUBIDENTITY(1:N)
   INTEGER(4) :: ILIST,ISUB,INEW

END MODULE



PROGRAM RUBIK_4X4X4
! BLANKET ENUMERATION OF 4x4x4 RUBIK'S CUBE CONFIGURATIONS.
! SO HIRATA, UNIVERSITY OF ILLINOIS AT URBANA-CHAMPAIGN, JANUARY 2024.

   USE RUBIK4

   IMPLICIT NONE

   INTERFACE
      INTEGER FUNCTION IEXIST(CONFIG)
         INTEGER(4) :: CONFIG(1:93)
      END FUNCTION
   END INTERFACE

   INTEGER(4)  :: I,J,K
   REAL :: START,FINISH,S2,F2
   INTEGER(4),PARAMETER :: MAXSTEPS=50
   INTEGER(4),PARAMETER :: ALGORITHM=2 ! 1 SORTED; 2 UNSORTED
   INTEGER(4) :: METRIC
!  INTEGER(4),PARAMETER :: METRIC=1 ! 1 QUARTER-TURN; 2 HALF-TURN; 3: SEMI-QUARTER-TURN METRIC; 4: TWO-QUARTER-TURN METRIC
   INTEGER(4) :: ICUBOID(1:93),JCUBOID(1:93),KCUBOID(1:93)
   INTEGER(4) :: ISTEP,JFOUND,ITURN,NTURN

   WRITE(6,'(A)') "4X4X4 RUBIK'S CUBE CONFIGURATION GENERATION"
!  WRITE(6,'(A)') '1: QUARTER-TURN METRIC; 2: HALF-TURN METRIC; 3: SEMI-QUARTER-TURN METRIC; 4: TWO-QUARTER-TURN METRIC'
   WRITE(6,'(A)') '1: QUARTER-TURN METRIC; 2: HALF-TURN METRIC'
   READ(5,*) METRIC
   IF (METRIC==1) THEN
    WRITE(6,'(A)') 'QUARTER-TURN METRIC'
   ELSE IF (METRIC==2) THEN
    WRITE(6,'(A)') 'HALF-TURN METRIC'
!  ELSE IF (METRIC==3) THEN
!   WRITE(6,'(A)') 'SEMI-QUARTER-TURN METRIC'
!  ELSE IF (METRIC==4) THEN
!   WRITE(6,'(A)') 'TWO-QUARTER-TURN METRIC'
   ELSE
    WRITE(6,'(A)') 'ILLEGAL METRIC'
    STOP
   ENDIF

   WRITE(6,'(A,I0)') 'MAX NUMBER OF CONFIGURATIONS = ',N

   LIST=0
   SUBLIST=0

   ! INITIAL CONFIGURATION
   ISTEP=0
   CALL INITIALIZE(ICUBOID)
   LIST(:,1)=ICUBOID(:)
   ILIST=1
   SUBLIST(:,1)=ICUBOID(:)
   SUBIDENTITY(1)=1
   ISUB=1
   INEW=0
   WRITE(6,'(3(A,I10))') 'STEP ',ISTEP,' NEW CONFIGS ',1,' CUMMULATIVE CONFIGS ',ILIST

   DO ISTEP=1,MAXSTEPS
    CALL CPU_TIME(START)
    CALL CPU_TIME(S2)
    NEWLIST=0
    NEWIDENTITY=0
    INEW=0
    DO I=1,ISUB
     IF (ISUB > 100000) THEN
      IF (MOD(I,10000)==0) THEN
       CALL CPU_TIME(F2)
       WRITE(6,'(A,I8,A,F20.3)') '    SEED CONFIGS ',I,' CPU TIME ',F2-S2
       CALL CPU_TIME(S2)
      ENDIF
     ENDIF
     ICUBOID(:)=SUBLIST(:,I)
!    QUARTER-TURN METRIC
     IF (METRIC==1) THEN
      NTURN=18
      DO ITURN=1,NTURN
       IF (ITURN== 1) CALL R1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 2) CALL R1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 3) CALL D1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 4) CALL D1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 5) CALL B1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 6) CALL B1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 7) CALL R2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 8) CALL R2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 9) CALL D2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==10) CALL D2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==11) CALL B2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==12) CALL B2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==13) CALL R3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==14) CALL R3(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==15) CALL D3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==16) CALL D3(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==17) CALL B3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==18) CALL B3(ICUBOID,JCUBOID,.FALSE.)
       JFOUND=IEXIST(JCUBOID)
       IF (JFOUND==0) THEN
        ILIST=ILIST+1
        IF (ILIST > N) THEN
         WRITE(6,'(A)') 'ERROR 2'
         STOP
        ENDIF
        LIST(:,ILIST)=JCUBOID(:)
        INEW=INEW+1
        IF (INEW > N) THEN
         WRITE(6,'(A)') 'ERROR 3'
         STOP
        ENDIF
        NEWLIST(:,INEW)=JCUBOID(:)
        NEWIDENTITY(INEW)=ILIST
if (istep <= 3) write(*,'(I4,A,I4,A)') SUBIDENTITY(I),'<->',ILIST,','
       ELSE
if (istep <= 3) write(*,'(I4,A,I4,A)') SUBIDENTITY(I),'<->',JFOUND,','
       ENDIF 
      ENDDO
!    HALF-TURN METRIC
     ELSE IF (METRIC==2) THEN
      NTURN=27
      DO ITURN=1,NTURN
       IF (ITURN== 1) CALL R1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 2) CALL R1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 3) CALL D1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 4) CALL D1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 5) CALL B1(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 6) CALL B1(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 7) CALL R2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN== 8) CALL R2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN== 9) CALL D2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==10) CALL D2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==11) CALL B2(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==12) CALL B2(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==13) CALL R3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==14) CALL R3(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==15) CALL D3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==16) CALL D3(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==17) CALL B3(ICUBOID,JCUBOID,.TRUE.)
       IF (ITURN==18) CALL B3(ICUBOID,JCUBOID,.FALSE.)
       IF (ITURN==19) THEN
        CALL R1(ICUBOID,KCUBOID,.TRUE.)
        CALL R1(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==20) THEN
        CALL D1(ICUBOID,KCUBOID,.TRUE.)
        CALL D1(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==21) THEN
        CALL B1(ICUBOID,KCUBOID,.TRUE.)
        CALL B1(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==22) THEN
        CALL R2(ICUBOID,KCUBOID,.TRUE.)
        CALL R2(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==23) THEN
        CALL D2(ICUBOID,KCUBOID,.TRUE.)
        CALL D2(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==24) THEN
        CALL B2(ICUBOID,KCUBOID,.TRUE.)
        CALL B2(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==25) THEN
        CALL R3(ICUBOID,KCUBOID,.TRUE.)
        CALL R3(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==26) THEN
        CALL D3(ICUBOID,KCUBOID,.TRUE.)
        CALL D3(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       IF (ITURN==27) THEN
        CALL B3(ICUBOID,KCUBOID,.TRUE.)
        CALL B3(KCUBOID,JCUBOID,.TRUE.)
       ENDIF
       JFOUND=IEXIST(JCUBOID)
       IF (JFOUND==0) THEN
        ILIST=ILIST+1
        IF (ILIST > N) THEN
         WRITE(6,'(A)') 'ERROR 5'
         STOP
        ENDIF
        LIST(:,ILIST)=JCUBOID(:)
        INEW=INEW+1
        IF (INEW > N) THEN
         WRITE(6,'(A)') 'ERROR 6'
         STOP
        ENDIF
        NEWLIST(:,INEW)=JCUBOID(:)
        NEWIDENTITY(INEW)=ILIST
if (istep <= 3) write(*,'(I4,A,I4,A)') SUBIDENTITY(I),'<->',ILIST,','
       ELSE
if (istep <= 3) write(*,'(I4,A,I4,A)') SUBIDENTITY(I),'<->',JFOUND,','
       ENDIF 
      ENDDO
     ENDIF
    ENDDO
    IF (INEW==0) THEN
     IF (ILIST==N) THEN
      EXIT
     ELSE
      WRITE(6,'(A,I0)') 'ILLEGAL TERMINATION WITH CUMMULATIVE CONFIGURATIONS ',ILIST
      EXIT
     ENDIF
    ENDIF
    CALL CPU_TIME(FINISH)
    WRITE(6,'(3(A,I10),A,F20.3)') 'STEP ',ISTEP,' NEW CONFIGS ',INEW,' CUMMULATIVE CONFIGS ',ILIST,' CPU TIME ',FINISH-START
    ISUB=INEW
    SUBLIST=NEWLIST
    SUBIDENTITY=NEWIDENTITY
   ENDDO
   CALL CPU_TIME(FINISH)

END PROGRAM



SUBROUTINE INITIALIZE(ICUBOID)
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!

   IMPLICIT NONE
   INTEGER(4)  :: I,J
   INTEGER(4)  :: ICUBOID(1:93)

   DO I=1,15
    ICUBOID(I)=1
   ENDDO
   DO I=16,30
    ICUBOID(I)=2
   ENDDO
   DO I=31,46
    ICUBOID(I)=3
   ENDDO
   DO I=47,62
    ICUBOID(I)=4
   ENDDO
   DO I=63,77
    ICUBOID(I)=5
   ENDDO
   DO I=78,93
    ICUBOID(I)=6
   ENDDO
!  WRITE(6,'(93I1)') (ICUBOID(I),I=1,93)

   RETURN

END SUBROUTINE



SUBROUTINE R1(ICUBOID,JCUBOID,LPRIME)
! PERFORM RIGHT-1 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(19)=ICUBOID( 3)
    JCUBOID(23)=ICUBOID( 7)
    JCUBOID(27)=ICUBOID(11)
    JCUBOID(30)=ICUBOID(15)

    JCUBOID(90)=ICUBOID(19)
    JCUBOID(86)=ICUBOID(23)
    JCUBOID(82)=ICUBOID(27)
    JCUBOID(78)=ICUBOID(30)

    JCUBOID(50)=ICUBOID(90)
    JCUBOID(54)=ICUBOID(86)
    JCUBOID(58)=ICUBOID(82)
    JCUBOID(62)=ICUBOID(78)

    JCUBOID( 3)=ICUBOID(50)
    JCUBOID( 7)=ICUBOID(54)
    JCUBOID(11)=ICUBOID(58)
    JCUBOID(15)=ICUBOID(62)

    JCUBOID(34)=ICUBOID(31)
    JCUBOID(38)=ICUBOID(32)
    JCUBOID(42)=ICUBOID(33)

    JCUBOID(46)=ICUBOID(34)
    JCUBOID(45)=ICUBOID(38)
    JCUBOID(44)=ICUBOID(42)

    JCUBOID(43)=ICUBOID(46)
    JCUBOID(39)=ICUBOID(45)
    JCUBOID(35)=ICUBOID(44)

    JCUBOID(31)=ICUBOID(43)
    JCUBOID(32)=ICUBOID(39)
    JCUBOID(33)=ICUBOID(35)

    JCUBOID(37)=ICUBOID(36)
    JCUBOID(41)=ICUBOID(37)
    JCUBOID(40)=ICUBOID(41)
    JCUBOID(36)=ICUBOID(40)
   ELSE
    JCUBOID( 3)=ICUBOID(19)
    JCUBOID( 7)=ICUBOID(23)
    JCUBOID(11)=ICUBOID(27)
    JCUBOID(15)=ICUBOID(30)
                          
    JCUBOID(19)=ICUBOID(90)
    JCUBOID(23)=ICUBOID(86)
    JCUBOID(27)=ICUBOID(82)
    JCUBOID(30)=ICUBOID(78)
                          
    JCUBOID(90)=ICUBOID(50)
    JCUBOID(86)=ICUBOID(54)
    JCUBOID(82)=ICUBOID(58)
    JCUBOID(78)=ICUBOID(62)
                          
    JCUBOID(50)=ICUBOID( 3)
    JCUBOID(54)=ICUBOID( 7)
    JCUBOID(58)=ICUBOID(11)
    JCUBOID(62)=ICUBOID(15)
                          
    JCUBOID(31)=ICUBOID(34)
    JCUBOID(32)=ICUBOID(38)
    JCUBOID(33)=ICUBOID(42)
                          
    JCUBOID(34)=ICUBOID(46)
    JCUBOID(38)=ICUBOID(45)
    JCUBOID(42)=ICUBOID(44)
                          
    JCUBOID(46)=ICUBOID(43)
    JCUBOID(45)=ICUBOID(39)
    JCUBOID(44)=ICUBOID(35)
                          
    JCUBOID(43)=ICUBOID(31)
    JCUBOID(39)=ICUBOID(32)
    JCUBOID(35)=ICUBOID(33)

    JCUBOID(36)=ICUBOID(37)
    JCUBOID(37)=ICUBOID(41)
    JCUBOID(41)=ICUBOID(40)
    JCUBOID(40)=ICUBOID(36)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE R2(ICUBOID,JCUBOID,LPRIME)
! PERFORM RIGHT-2 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(18)=ICUBOID( 2)
    JCUBOID(22)=ICUBOID( 6)
    JCUBOID(26)=ICUBOID(10)
    JCUBOID(29)=ICUBOID(14)

    JCUBOID(91)=ICUBOID(18)
    JCUBOID(87)=ICUBOID(22)
    JCUBOID(83)=ICUBOID(26)
    JCUBOID(79)=ICUBOID(29)

    JCUBOID(49)=ICUBOID(91)
    JCUBOID(53)=ICUBOID(87)
    JCUBOID(57)=ICUBOID(83)
    JCUBOID(61)=ICUBOID(79)

    JCUBOID( 2)=ICUBOID(49)
    JCUBOID( 6)=ICUBOID(53)
    JCUBOID(10)=ICUBOID(57)
    JCUBOID(14)=ICUBOID(61)
   ELSE
    JCUBOID( 2)=ICUBOID(18)
    JCUBOID( 6)=ICUBOID(22)
    JCUBOID(10)=ICUBOID(26)
    JCUBOID(14)=ICUBOID(29)
                          
    JCUBOID(18)=ICUBOID(91)
    JCUBOID(22)=ICUBOID(87)
    JCUBOID(26)=ICUBOID(83)
    JCUBOID(29)=ICUBOID(79)
                          
    JCUBOID(91)=ICUBOID(49)
    JCUBOID(87)=ICUBOID(53)
    JCUBOID(83)=ICUBOID(57)
    JCUBOID(79)=ICUBOID(61)
                          
    JCUBOID(49)=ICUBOID( 2)
    JCUBOID(53)=ICUBOID( 6)
    JCUBOID(57)=ICUBOID(10)
    JCUBOID(61)=ICUBOID(14)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE R3(ICUBOID,JCUBOID,LPRIME)
! PERFORM RIGHT-3 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(17)=ICUBOID( 1)
    JCUBOID(21)=ICUBOID( 5)
    JCUBOID(25)=ICUBOID( 9)
    JCUBOID(28)=ICUBOID(13)

    JCUBOID(92)=ICUBOID(17)
    JCUBOID(88)=ICUBOID(21)
    JCUBOID(84)=ICUBOID(25)
    JCUBOID(80)=ICUBOID(28)

    JCUBOID(48)=ICUBOID(92)
    JCUBOID(52)=ICUBOID(88)
    JCUBOID(56)=ICUBOID(84)
    JCUBOID(60)=ICUBOID(80)

    JCUBOID( 1)=ICUBOID(48)
    JCUBOID( 5)=ICUBOID(52)
    JCUBOID( 9)=ICUBOID(56)
    JCUBOID(13)=ICUBOID(60)
   ELSE
    JCUBOID( 1)=ICUBOID(17)
    JCUBOID( 5)=ICUBOID(21)
    JCUBOID( 9)=ICUBOID(25)
    JCUBOID(13)=ICUBOID(28)
                          
    JCUBOID(17)=ICUBOID(92)
    JCUBOID(21)=ICUBOID(88)
    JCUBOID(25)=ICUBOID(84)
    JCUBOID(28)=ICUBOID(80)
                          
    JCUBOID(92)=ICUBOID(48)
    JCUBOID(88)=ICUBOID(52)
    JCUBOID(84)=ICUBOID(56)
    JCUBOID(80)=ICUBOID(60)
                          
    JCUBOID(48)=ICUBOID( 1)
    JCUBOID(52)=ICUBOID( 5)
    JCUBOID(56)=ICUBOID( 9)
    JCUBOID(60)=ICUBOID(13)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE D1(ICUBOID,JCUBOID,LPRIME)
! PERFORM DOWN-1 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(43)=ICUBOID(12)
    JCUBOID(44)=ICUBOID(13)
    JCUBOID(45)=ICUBOID(14)
    JCUBOID(46)=ICUBOID(15)

    JCUBOID(90)=ICUBOID(43)
    JCUBOID(91)=ICUBOID(44)
    JCUBOID(92)=ICUBOID(45)
    JCUBOID(93)=ICUBOID(46)

    JCUBOID(74)=ICUBOID(90)
    JCUBOID(75)=ICUBOID(91)
    JCUBOID(76)=ICUBOID(92)
    JCUBOID(77)=ICUBOID(93)

    JCUBOID(12)=ICUBOID(74)
    JCUBOID(13)=ICUBOID(75)
    JCUBOID(14)=ICUBOID(76)
    JCUBOID(15)=ICUBOID(77)

    JCUBOID(50)=ICUBOID(47)
    JCUBOID(54)=ICUBOID(48)
    JCUBOID(58)=ICUBOID(49)

    JCUBOID(62)=ICUBOID(50)
    JCUBOID(61)=ICUBOID(54)
    JCUBOID(60)=ICUBOID(58)

    JCUBOID(59)=ICUBOID(62)
    JCUBOID(55)=ICUBOID(61)
    JCUBOID(51)=ICUBOID(60)

    JCUBOID(47)=ICUBOID(59)
    JCUBOID(48)=ICUBOID(55)
    JCUBOID(49)=ICUBOID(51)

    JCUBOID(53)=ICUBOID(52)
    JCUBOID(57)=ICUBOID(53)
    JCUBOID(56)=ICUBOID(57)
    JCUBOID(52)=ICUBOID(56)
   ELSE
    JCUBOID(12)=ICUBOID(43)
    JCUBOID(13)=ICUBOID(44)
    JCUBOID(14)=ICUBOID(45)
    JCUBOID(15)=ICUBOID(46)
                          
    JCUBOID(43)=ICUBOID(90)
    JCUBOID(44)=ICUBOID(91)
    JCUBOID(45)=ICUBOID(92)
    JCUBOID(46)=ICUBOID(93)
                          
    JCUBOID(90)=ICUBOID(74)
    JCUBOID(91)=ICUBOID(75)
    JCUBOID(92)=ICUBOID(76)
    JCUBOID(93)=ICUBOID(77)
                          
    JCUBOID(74)=ICUBOID(12)
    JCUBOID(75)=ICUBOID(13)
    JCUBOID(76)=ICUBOID(14)
    JCUBOID(77)=ICUBOID(15)
                          
    JCUBOID(47)=ICUBOID(50)
    JCUBOID(48)=ICUBOID(54)
    JCUBOID(49)=ICUBOID(58)
                          
    JCUBOID(50)=ICUBOID(62)
    JCUBOID(54)=ICUBOID(61)
    JCUBOID(58)=ICUBOID(60)
                          
    JCUBOID(62)=ICUBOID(59)
    JCUBOID(61)=ICUBOID(55)
    JCUBOID(60)=ICUBOID(51)
                          
    JCUBOID(59)=ICUBOID(47)
    JCUBOID(55)=ICUBOID(48)
    JCUBOID(51)=ICUBOID(49)
                          
    JCUBOID(52)=ICUBOID(53)
    JCUBOID(53)=ICUBOID(57)
    JCUBOID(57)=ICUBOID(56)
    JCUBOID(56)=ICUBOID(52)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE D2(ICUBOID,JCUBOID,LPRIME)
! PERFORM DOWN-2 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(39)=ICUBOID( 8)
    JCUBOID(40)=ICUBOID( 9)
    JCUBOID(41)=ICUBOID(10)
    JCUBOID(42)=ICUBOID(11)

    JCUBOID(86)=ICUBOID(39)
    JCUBOID(87)=ICUBOID(40)
    JCUBOID(88)=ICUBOID(41)
    JCUBOID(89)=ICUBOID(42)

    JCUBOID(70)=ICUBOID(86)
    JCUBOID(71)=ICUBOID(87)
    JCUBOID(72)=ICUBOID(88)
    JCUBOID(73)=ICUBOID(89)

    JCUBOID( 8)=ICUBOID(70)
    JCUBOID( 9)=ICUBOID(71)
    JCUBOID(10)=ICUBOID(72)
    JCUBOID(11)=ICUBOID(73)
   ELSE
    JCUBOID( 8)=ICUBOID(39)
    JCUBOID( 9)=ICUBOID(40)
    JCUBOID(10)=ICUBOID(41)
    JCUBOID(11)=ICUBOID(42)
                          
    JCUBOID(39)=ICUBOID(86)
    JCUBOID(40)=ICUBOID(87)
    JCUBOID(41)=ICUBOID(88)
    JCUBOID(42)=ICUBOID(89)
                          
    JCUBOID(86)=ICUBOID(70)
    JCUBOID(87)=ICUBOID(71)
    JCUBOID(88)=ICUBOID(72)
    JCUBOID(89)=ICUBOID(73)
                          
    JCUBOID(70)=ICUBOID( 8)
    JCUBOID(71)=ICUBOID( 9)
    JCUBOID(72)=ICUBOID(10)
    JCUBOID(73)=ICUBOID(11)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE D3(ICUBOID,JCUBOID,LPRIME)
! PERFORM DOWN-3 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(35)=ICUBOID( 4)
    JCUBOID(36)=ICUBOID( 5)
    JCUBOID(37)=ICUBOID( 6)
    JCUBOID(38)=ICUBOID( 7)

    JCUBOID(82)=ICUBOID(35)
    JCUBOID(83)=ICUBOID(36)
    JCUBOID(84)=ICUBOID(37)
    JCUBOID(85)=ICUBOID(38)

    JCUBOID(66)=ICUBOID(82)
    JCUBOID(67)=ICUBOID(83)
    JCUBOID(68)=ICUBOID(84)
    JCUBOID(69)=ICUBOID(85)

    JCUBOID( 4)=ICUBOID(66)
    JCUBOID( 5)=ICUBOID(67)
    JCUBOID( 6)=ICUBOID(68)
    JCUBOID( 7)=ICUBOID(69)
   ELSE
    JCUBOID( 4)=ICUBOID(35)
    JCUBOID( 5)=ICUBOID(36)
    JCUBOID( 6)=ICUBOID(37)
    JCUBOID( 7)=ICUBOID(38)
                          
    JCUBOID(35)=ICUBOID(82)
    JCUBOID(36)=ICUBOID(83)
    JCUBOID(37)=ICUBOID(84)
    JCUBOID(38)=ICUBOID(85)
                          
    JCUBOID(82)=ICUBOID(66)
    JCUBOID(83)=ICUBOID(67)
    JCUBOID(84)=ICUBOID(68)
    JCUBOID(85)=ICUBOID(69)
                          
    JCUBOID(66)=ICUBOID( 4)
    JCUBOID(67)=ICUBOID( 5)
    JCUBOID(68)=ICUBOID( 6)
    JCUBOID(69)=ICUBOID( 7)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE B1(ICUBOID,JCUBOID,LPRIME)
! PERFORM BACK-1 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(74)=ICUBOID(16)
    JCUBOID(70)=ICUBOID(17)
    JCUBOID(66)=ICUBOID(18)
    JCUBOID(63)=ICUBOID(19)

    JCUBOID(62)=ICUBOID(74)
    JCUBOID(61)=ICUBOID(70)
    JCUBOID(60)=ICUBOID(66)
    JCUBOID(59)=ICUBOID(63)

    JCUBOID(34)=ICUBOID(62)
    JCUBOID(38)=ICUBOID(61)
    JCUBOID(42)=ICUBOID(60)
    JCUBOID(46)=ICUBOID(59)

    JCUBOID(16)=ICUBOID(34)
    JCUBOID(17)=ICUBOID(38)
    JCUBOID(18)=ICUBOID(42)
    JCUBOID(19)=ICUBOID(46)

    JCUBOID(81)=ICUBOID(78)
    JCUBOID(85)=ICUBOID(79)
    JCUBOID(89)=ICUBOID(80)

    JCUBOID(93)=ICUBOID(81)
    JCUBOID(92)=ICUBOID(85)
    JCUBOID(91)=ICUBOID(89)

    JCUBOID(90)=ICUBOID(93)
    JCUBOID(86)=ICUBOID(92)
    JCUBOID(82)=ICUBOID(91)

    JCUBOID(78)=ICUBOID(90)
    JCUBOID(79)=ICUBOID(86)
    JCUBOID(80)=ICUBOID(82)

    JCUBOID(84)=ICUBOID(83)
    JCUBOID(88)=ICUBOID(84)
    JCUBOID(87)=ICUBOID(88)
    JCUBOID(83)=ICUBOID(87)
   ELSE
    JCUBOID(16)=ICUBOID(74)
    JCUBOID(17)=ICUBOID(70)
    JCUBOID(18)=ICUBOID(66)
    JCUBOID(19)=ICUBOID(63)
                          
    JCUBOID(74)=ICUBOID(62)
    JCUBOID(70)=ICUBOID(61)
    JCUBOID(66)=ICUBOID(60)
    JCUBOID(63)=ICUBOID(59)
                          
    JCUBOID(62)=ICUBOID(34)
    JCUBOID(61)=ICUBOID(38)
    JCUBOID(60)=ICUBOID(42)
    JCUBOID(59)=ICUBOID(46)
                          
    JCUBOID(34)=ICUBOID(16)
    JCUBOID(38)=ICUBOID(17)
    JCUBOID(42)=ICUBOID(18)
    JCUBOID(46)=ICUBOID(19)
                          
    JCUBOID(78)=ICUBOID(81)
    JCUBOID(79)=ICUBOID(85)
    JCUBOID(80)=ICUBOID(89)
                          
    JCUBOID(81)=ICUBOID(93)
    JCUBOID(85)=ICUBOID(92)
    JCUBOID(89)=ICUBOID(91)
                          
    JCUBOID(93)=ICUBOID(90)
    JCUBOID(92)=ICUBOID(86)
    JCUBOID(91)=ICUBOID(82)
                          
    JCUBOID(90)=ICUBOID(78)
    JCUBOID(86)=ICUBOID(79)
    JCUBOID(82)=ICUBOID(80)
                          
    JCUBOID(83)=ICUBOID(84)
    JCUBOID(84)=ICUBOID(88)
    JCUBOID(88)=ICUBOID(87)
    JCUBOID(87)=ICUBOID(83)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE B2(ICUBOID,JCUBOID,LPRIME)
! PERFORM BACK-2 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(75)=ICUBOID(20)
    JCUBOID(71)=ICUBOID(21)
    JCUBOID(67)=ICUBOID(22)
    JCUBOID(64)=ICUBOID(23)

    JCUBOID(58)=ICUBOID(75)
    JCUBOID(57)=ICUBOID(71)
    JCUBOID(56)=ICUBOID(67)
    JCUBOID(55)=ICUBOID(64)

    JCUBOID(33)=ICUBOID(58)
    JCUBOID(37)=ICUBOID(57)
    JCUBOID(41)=ICUBOID(56)
    JCUBOID(45)=ICUBOID(55)

    JCUBOID(20)=ICUBOID(33)
    JCUBOID(21)=ICUBOID(37)
    JCUBOID(22)=ICUBOID(41)
    JCUBOID(23)=ICUBOID(45)
   ELSE
    JCUBOID(20)=ICUBOID(75)
    JCUBOID(21)=ICUBOID(71)
    JCUBOID(22)=ICUBOID(67)
    JCUBOID(23)=ICUBOID(64)
                          
    JCUBOID(75)=ICUBOID(58)
    JCUBOID(71)=ICUBOID(57)
    JCUBOID(67)=ICUBOID(56)
    JCUBOID(64)=ICUBOID(55)
                          
    JCUBOID(58)=ICUBOID(33)
    JCUBOID(57)=ICUBOID(37)
    JCUBOID(56)=ICUBOID(41)
    JCUBOID(55)=ICUBOID(45)
                          
    JCUBOID(33)=ICUBOID(20)
    JCUBOID(37)=ICUBOID(21)
    JCUBOID(41)=ICUBOID(22)
    JCUBOID(45)=ICUBOID(23)
   ENDIF
   RETURN

END SUBROUTINE



SUBROUTINE B3(ICUBOID,JCUBOID,LPRIME)
! PERFORM BACK-3 LAYER ROTATE BY 90 DEGREES
!
!             16 17 18 19
!             20 21 22 23
!             24 25 26 27
!              U 28 29 30
! 63 64 65  L  F  1  2  3 31 32 33 34 78 79 80 81
! 66 67 68 69  4  5  6  7 35 36 37 38 82 83 84 85
! 70 71 72 73  8  9 10 11 39 40 41 42 86 87 88 89
! 74 75 76 77 12 13 14 15 43 44 45 46 90 91 92 93
!             47 48 49 50
!             51 52 53 54
!             55 56 57 58
!             59 60 61 62
!   
   IMPLICIT NONE
   INTEGER(4)  :: ICUBOID(1:93)
   INTEGER(4)  :: JCUBOID(1:93)
   LOGICAL     :: LPRIME ! TRUE CLOCKWISE; FALSE COUNTERCLOCKWISE

   JCUBOID=ICUBOID

   IF (LPRIME) THEN
    JCUBOID(76)=ICUBOID(24)
    JCUBOID(72)=ICUBOID(25)
    JCUBOID(68)=ICUBOID(26)
    JCUBOID(65)=ICUBOID(27)

    JCUBOID(54)=ICUBOID(76)
    JCUBOID(53)=ICUBOID(72)
    JCUBOID(52)=ICUBOID(68)
    JCUBOID(51)=ICUBOID(65)

    JCUBOID(32)=ICUBOID(54)
    JCUBOID(36)=ICUBOID(53)
    JCUBOID(40)=ICUBOID(52)
    JCUBOID(44)=ICUBOID(51)

    JCUBOID(24)=ICUBOID(32)
    JCUBOID(25)=ICUBOID(36)
    JCUBOID(26)=ICUBOID(40)
    JCUBOID(27)=ICUBOID(44)
   ELSE
    JCUBOID(24)=ICUBOID(76)
    JCUBOID(25)=ICUBOID(72)
    JCUBOID(26)=ICUBOID(68)
    JCUBOID(27)=ICUBOID(65)
                          
    JCUBOID(76)=ICUBOID(54)
    JCUBOID(72)=ICUBOID(53)
    JCUBOID(68)=ICUBOID(52)
    JCUBOID(65)=ICUBOID(51)
                          
    JCUBOID(54)=ICUBOID(32)
    JCUBOID(53)=ICUBOID(36)
    JCUBOID(52)=ICUBOID(40)
    JCUBOID(51)=ICUBOID(44)
                          
    JCUBOID(32)=ICUBOID(24)
    JCUBOID(36)=ICUBOID(25)
    JCUBOID(40)=ICUBOID(26)
    JCUBOID(44)=ICUBOID(27)
   ENDIF
   RETURN

END SUBROUTINE



INTEGER FUNCTION IEXIST(CONFIG)
! RETURN TRUE IF CONFIG EXISTS IN THE LIST

   USE RUBIK4

   INTEGER(4)  :: CONFIG(1:93)
   INTEGER(4)  :: I,J,K

   ! DEBUG
   IF (ILIST < 0) THEN
    K=0
    DO J=1,93
     K=K+CONFIG(J)
    ENDDO
    WRITE(6,'(A,93I1,I5)') 'CONFIG  =',(CONFIG(J),J=1,93),K
    WRITE(6,*) 'LIST=',ILIST
    DO I=1,ILIST
     WRITE(6,'(I3,X,93I1)') I,(LIST(J,I),J=1,93)
    ENDDO
   ENDIF

   IEXIST=0
   IF (ILIST==0) RETURN
   DO I=1,ILIST
    K=1
    DO J=1,93
     IF (CONFIG(J)/=LIST(J,I)) THEN
      K=0
      EXIT
     ENDIF
    ENDDO
    IF (K==1) THEN
     IEXIST=I
     EXIT
    ENDIF
   ENDDO
   IF (ILIST < 0) THEN
    IF (IEXIST==0) WRITE(6,'(A)') 'NOT EXIST'
    IF (IEXIST/=0) WRITE(6,'(A,I3,X,93I1)') 'EXIST',I,(LIST(J,I),J=1,93)
   ENDIF

   RETURN

END FUNCTION
